# 消息队列的设计

不同的消息队列采取各种各样的方法，并没有针对所有目的的通用答案。为了区分这些系统，问一下这两个问题会特别有帮助：

- 如果生产者发送消息的速度比消费者能够处理的速度快会发生什么？一般来说，有三种选择：系统可以丢掉消息，将消息放入缓冲队列，或使用背压（backpressure）（也称为**流量控制（flow control）；**即阻塞生产者，以免其发送更多的消息）。例如 Unix 管道和 TCP 使用背压：它们有一个固定大小的小缓冲区，如果填满，发送者会被阻塞，直到接收者从缓冲区中取出数据。

- 如果节点崩溃或暂时脱机，会发生什么情况？是否会有消息丢失？与数据库一样，持久性可能需要写入磁盘和/或复制的某种组合，这是有代价的。如果你能接受有时消息会丢失，则可能在同一硬件上获得更高的吞吐量和更低的延迟。是否可以接受消息丢失取决于应用。例如，对于周期传输的传感器读数和指标，偶尔丢失的数据点可能并不重要，因为更新的值会在短时间内发出。但要注意，如果大量的消息被丢弃，可能无法立刻意识到指标已经不正确了。如果你正在对事件计数，那么更重要的是它们能够可靠送达，因为每个丢失的消息都意味着使计数器的错误扩大。批处理系统的一个很好的特性是，它们提供了强大的可靠性保证：失败的任务会自动重试，失败任务的部分输出会自动丢弃。这意味着输出与没有发生故障一样，这有助于简化编程模型。

# 基础概念

- AMQP：AMQP 是一种开放的 Internet 协议，用于可靠地发送和接收消息。

- MOM：面向消息的中间件是一种方法，是一种分布式系统的体系结构，即整个分布式系统的中间层，其中存在大量内部通信（一个组件正在查询数据，然后需要将其发送给另一个 组件，它将对数据进行一些处理），因此组件必须在它们之间共享信息/数据。

- Message Broker 消息代理：是在 MOM 中处理消息（发送和接收）的任何系统，或更确切地说，是将消息路由到特定使用者/收件人的任何系统。消息代理通常基于 MOM 构建。MOM 提供了应用程序之间的基本通信，以及诸如消息持久性和保证的传递之类的东西。“消息代理是面向消息的中间件的构建块。”

# Links

- https://mp.weixin.qq.com/s/hYfTl8eR2Vkue8-EpgZY7g
- https://mp.weixin.qq.com/s/y3CheyPMJpLpD3pB3lTT9g
- https://zhuanlan.zhihu.com/p/34700753
- https://zhuanlan.zhihu.com/p/72728396
- https://mp.weixin.qq.com/s/nAjYhuN3ptAqaE67bqc4aQ
- https://github.com/qunarcorp/qmq 学习 qmq 中的实践
- https://mp.weixin.qq.com/s/j905XZcZewI-0m-mcU7Wng 消息中间件的四种投递模式对比
